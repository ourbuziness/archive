<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Mosallas</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=0.5, maximum-scale=1">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<link rel="stylesheet" href="nft-style.css">
	<canvas id="whole" style="position: absolute;z-index:999;width:100%;height:100%"></canvas>
	<p id="pos" style="position: absolute;z-index:999;background-color: #fff;left:40px">position</p>
	<p id="changes" style="position: absolute;z-index:999;background-color: #fff;left:40px;top:100px">changes</p>
	<button id="reset" style="position: absolute;z-index:999;bottom: 100px; right:100px;height:40px">try sgain</button>
	<progress id="power" value="10" max="100" style="-webkit-transform: rotate(-90deg); position: absolute;z-index:999;bottom:150px; right:-100px;width:350px;height:40px;background-color: #9c27b0; "></progress>

</head>
<body>

	<audio id="kick">
		<source src="kick.mp3.mp3" type="audio/mpeg"></source>
	</audio>

	<audio id="myAudio1">
		<source src="count.mp3" type="audio/mpeg"></source>
	</audio>
	
	
		<script src="three.min.js"></script>
		<script src="ARnft.js"></script>
        	<script type='text/javascript' src='Tween.js'></script>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
		<script type='text/javascript' src='OrbitControls.js'></script>
		<script src="confetti.js"></script>
		<script src="jquery.min.js"></script>
	
    <script>
      
      let nft_loaded;
	    let goal ;
	    let ball ;
	    let path ;
	    let pointsPath;
	    let y4;
        let length = 50;
        let height = 20;
	let sheddatArray = [70,90,95,100,110,120,130,140,150,180];
        let shedat = 1;
	    let prog = 10;
	    let steps = 0.05;
	    let end = false ;
	    let fraction = 0
	    const up = new THREE.Vector3( 0,1, 0 );
  	    const axis = new THREE.Vector3( );
	    let interval;
	    let step = 10 // for interval power
        let v0;
        let gg = 9.8
        let A;
	    let vy;
	    let vz;
        let alpha;
	    let time;
	    let endx
	    let endy
	    let startx
	    let starty
	    let shib
	    let starte
	    let canStarte = true
	    let keeper
	    let keeperx = 0
	    let keeperStep = 0.8
	    let ghaltkhorde = 40
	    let totalDistance = -1
	    
	    let latestMatrix = null
	    let maxes = [
    0, 0, 0, 0,
    0, 0, 0, 0,
    0, 0, 0, 0,
    0, 0, 0, 0
  ]
	    	    let sums = [
    0, 0, 0, 0,
    0, 0, 0, 0,
    0, 0, 0, 0,
    0, 0, 0, 0
  ]
		    
// var stableMatrix =[
//   0.0002 ,0.0003 ,0.003 ,0 ,
//   0.0002 , 0.0002 , 0.0009,0,
//   0.003,0.0009,0.00025,0,
//   0.092,0.12 , 0.33 ,0
// ]
		    
// 		    var stableMatrix =[
//   0.0014 ,0.003 ,0.014 ,0 ,
//   0.0056 , 0.0016 , 0.006,0,
//   0.014,0.006,0.003,0,
//   0.4,0.5 , 2.5 ,0
// ]
		    
		    var stableMatrix =[
  0.0005 ,0.00068 ,0.003 ,0 ,
  0.00035 , 0.00035 , 0.0009,0,
  0.003,0.0009,0.00025,0,
  0.092,0.12 , 0.4 ,0
]
		    
	    
	    var timeStamp = -1
            var count = 0
	    var isBreak = false
	    var unlocked = false
      
	       $("#reset").click(function(){
        reset();
    }); 
	
	    
	    
      function createPath(x,y,z){
	    //  alert("ymz")
	      try{
	//if(x==0)
             A = x
       //  else
	  //   A = Math.tan(x)
		     // alert("A : "+A);
		      if(z>0)
        alpha = z*Math.PI / 180
		      else
			      alpha = 0
		    //   alert("alpha : "+alpha);
		      vy = v0*Math.cos(alpha)
        vz = v0*Math.sin(alpha)
//         var R = v0*v0*Math.sin(2*alpha)/gg

        time = 0;
			//alert("time : "+time);
		      end = false;
		      ghaltkhorde = 40
		      totalDistance = (2*vz*vy) / gg
		      
        nft_loaded.tickExtend = function(){
		//alert("tick");
		keeperx += keeperStep
		if(keeperx >100) keeperStep = -1 * keeperStep
		if(keeperx <=0) keeperStep = -1 * keeperStep
		keeper.position.x = keeperx
          if(!end){
		  try{
			  
            time += steps
            createCubic(time);
		  }catch(e){
			alert(e)  
		  }
		  
          }else {
		 
		//alert("end")  
	  }

        };
	      }catch(e){alert(e)}
        
      }
	    
	    function reset(){
		ball.position.x = 70
		  ball.position.y = 5
		    ball.position.z = 0
		    time = 0
		    clearInterval(interval);
		    startInterval()
		  //  end = false
		    
		    
	    }

      function createCubic(time){
     try{
	    // alert("here");
        
        var y = vy*time + 5
        var z = 0
	if(vz !=0 )
	   z= -0.5*gg**time*time + vz*time 
	     else
	z=0
		     
        var x = linearPath(y) + 70
	
// 	$("#pos").text("( "+ x+" , "+y+" , "+z+" )")

        if(((ball.position.z <= 0 /*|| ball.position.y >= goal.position.y*/ ) && time > 0.1) || ghaltkhorde < 40){
		//alert("end")
		
		if(ghaltkhorde == 40 )
			ball.position.z = 0
		
		 if(ghaltkhorde > 0){
// 			 $("#pos").text(ball.rotation.x)
// 			  $("#pos").text(" y : "+ ball.position.y + " x : "+ ball.position.x + " A : " + A)
			ball.position.y = ball.position.y + 1
			 ball.position.z = 10*Math.abs(Math.sin(ghaltkhorde/6))
			ball.position.x = linearPath(ball.position.y) + 70
			  ball.rotation.x -= ((ghaltkhorde/80)*0.62 + 0.1)
			 ghaltkhorde --;

		  }else{
          		end = true
		  }
        }else{
          ball.position.x = x
          ball.position.y= y
          ball.position.z = z
          ball.rotation.x -= 0.72
// 		 $("#pos").text(ball.rotation.x)
        }
	        }catch(e){
			alert(e);    
		    }
      }

      function linearPath(y){
	      var x = 1
	      if(A !=0)
       		x = y / A
	      else
		x = 0
        return x
      }
	    
	    function startInterval(){
		    interval = setInterval(function() {
	  prog = prog + step
	  if(prog>100){
		  prog = 90
		  step = -10
	  }
	  if(prog <0 ){
		  prog = 10
		  step = 10
	  }
   document.getElementById("power").value = prog;
 }, 140);
		    
	    }
	    
	    window.addEventListener('touchstart', () => {
		    unlocked = true
	    })
	    
	    document.addEventListener('touchmove', this.preventDefault, {passive: false});

			ARnft.ARnft.init(800, 600, "archive/DataNFT/sun_small1", 'config3.json', false, true)
			.then((nft) => {
				startInterval()
				nft_loaded = nft;

				document.addEventListener('onInitThreejsRendering', (ev) => {
					const renderer = ev.detail.renderer;
					const scene = ev.detail.scene;
					const camera = ev.detail.camera;
					
  					renderer.outputEncoding = THREE.sRGBEncoding;
                                        renderer.textureEncoding = THREE.sRGBEncoding
					renderer.physicallyCorrectLights = true;
				
					const light1  = new THREE.AmbientLight(0xFFFFFF, 0.3);
					    light1.name = 'ambient_light';
					    camera.add( light1 );

					let directionalLight = new THREE.DirectionalLight(0xFFFFFF, 0.8 * Math.PI);
					directionalLight.position.set(0.5, 0, 0.866);
					camera.add(directionalLight);

					 nft.addSimpleModel('./keeper.glb' , 60 , 140 ,0,4 , function(model){
						 keeper = model
						 keeper.rotation.y = 0
                                                 keeper.rotation.x = Math.PI/2

					 });
          
					 nft.addSimpleAnimatedCompressedModel('./field2.glb' , 60 , 84 ,-10,0.5 , function(gltf,model){
						 model.rotation.x = Math.PI/2
					 });
						 
          nft.addSimpleModel('./ball2.glb' , 72 , 5 ,0,8, function(model){
		  ball = model;
		  
		  nft.setOnObjectClickListener('./ball2.glb',function(startEvent,endEvent,point){
			//   alert("clicked")
			  
			  var audio = document.getElementById("kick");
                              audio.play();
			  
			 clearInterval(interval);
			  shedat = sheddatArray[(prog/10 | 0)]
			  v0 = sheddatArray[(prog/10 | 0)]
//v0 = 140
 			  var v = new THREE.Vector3()

 			  model.getWorldPosition(v)

			  var p1 =  model.worldToLocal(point);
			  var p2 = model.worldToLocal(v);

			 var yys = (p1.y - p2.y)* 100 | 0
// 			 var zzs = (p1.z - p2.z)*100 | 0
// 			 zzs = -1*zzs
// 			 if(zzs < -80 || zzs >70){
// 				zzs = 0	 
// 			 }else{
// 				zzs = ((zzs + 80)* 72)/130
// 			 }
			  try{

				startx =  startx= startEvent.touches[0].pageX
   				starty= startEvent.touches[0].pageY
			  
				endx= endEvent.changedTouches[0].pageX;
				endy= endEvent.changedTouches[0].pageY;
					
				shib = (endy - starty) / (endx - startx)
				  
				var zpower = Math.sqrt( Math.pow(endy - starty,2) + Math.pow(endx - startx,2) )
				if(zpower < 0 ) zpower = -1 * zpower
				 if(zpower > 350 ) zpower = 80
				  else{
					zpower = ((zpower * 80)/350)
				  }
				  
			var xxs = -1* shib
  createPath(xxs,yys + 28 ,zpower);
//    			 $("#pos").text("power : "+ zpower +"\nx : " + xxs)
			  }catch(e){
			alert(e);	  
			  }
			 
		  });

						
									});
          
          
                    nft.addSimpleAnimatedCompressedModel('./goal1.glb' , 60 , 144 ,0,0.14 ,function(gltf,model){

					goal = model;
			    model.rotation.x = (Math.PI/2)
			    model.rotation.y = (Math.PI/-2)
//  			    model.rotation.y = (Math.PI)
// 			    model.rotation.z = (Math.PI)
									});
					
					

				});
				
				
			
				document.addEventListener('getMatrixGL_RH', (ev) => {
				   try{

    var mdata = ev.detail.matrixGL_RH
    if(unlocked){ 
   /*if(timeStamp == -1){
        timeStamp = Date.now()
           latestMatrix = mdata
    }else{
       var newTime = Date.now()
       if((newTime - timeStamp)>20){
           var tt = ""
           timeStamp = newTime
           count++
           for(let i =0 ; i< 16; i++){
            var speed = Math.abs(latestMatrix[i] - mdata[i]) / 20
            if(speed > maxes[i] ) maxes[i] = speed
            var sum =  (speed + sums[i])
            sums[i] = sum
            var mean = sum/count
            tt = tt + /*"speed + "  max : " +  (maxes[i].toFixed(5)) + " mean : " + (mean.toFixed(5)) + " <br/>"
           }
           latestMatrix = mdata
           $("#pos").html(tt)
       }
       }
    }*/
             
if(timeStamp == -1){
     timeStamp = Date.now()
       latestMatrix = mdata

     }else{
    var newTime = Date.now()
    if((newTime - timeStamp)>50){
      var tt = ""
      isBreak = false
      timeStamp = newTime
      for(let i =0 ; i< 16; i++){
       var speed = Math.abs(latestMatrix[i] - mdata[i]) / 50
       if(speed > stableMatrix[i]){
         isBreak = true
	    $("#changes").text("i = " +i + "  speed : " + speed )
           $("#pos").text("در حال حرکت")
        // Utils.setInterpolate(data)
        // Utils.setMatrix(this.root.matrix, data)
         break;
       }
      }
      latestMatrix = mdata
      if(!isBreak){
           $("#pos").text("ثابت")
       //const matrix = Utils.interpolate(data)
       //Utils.setMatrix(this.root.matrix, matrix)
      }
     
}
     


   }
}
}catch(e){
   alert(e)
   }
				});
			
            });
	    
 
	    
    </script>
</body>

</html>
