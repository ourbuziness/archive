<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Mosallas</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=0.5, maximum-scale=1">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<link rel="stylesheet" href="nft-style.css">
	<canvas id="whole" style="position: absolute;z-index:999"></canvas>
</head>
<body>

	<audio id="myAudio">
		<source src="win.mp3" type="audio/mpeg"></source>
	</audio>

	<audio id="myAudio1">
		<source src="count.mp3" type="audio/mpeg"></source>
	</audio>
	
	
		<script src="three.min.js"></script>
		<script src="ARnft.js"></script>
        	<script type='text/javascript' src='Tween.js'></script>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
		<script type='text/javascript' src='OrbitControls.js'></script>
		<script src="confetti.js"></script>
	
	
    <script>
      
      let ps5
      let box
      let flag = true
      let secondStart = true
      let finished = false 
      let confetiStart = false
      let canPlay = true;
      let nft_loaded 
      let lastNumber = 9
      

	var current0 = { wait : 0}
    var current1	= { time : 0 };
	var current2 = { scale : 35}
	var current3 = {rotation: 0 , scale : 0.14}
	
	var update0 = function() {
		
	}
	
    var update1	= function(){
	    	if(!finished){
			box.rotation.y += 0.1
			var sec = Math.floor(current1.time /1000)
			if(sec != lastNumber){
			try{
			var object = nft_loaded.root.getObjectByName( "text" );
			nft_loaded.root.remove(object);
			}catch(e){ }
				nft_loaded.addSimpleText( 140 , 0 ,0 , "00:0"+(8 - sec ) ,"text" ,"rgba(228, 233, 237, 1)","rgba(142, 68, 173, 1)" , 19 );
			}
		}
	}
    
    var update2 = function(){
	    if(current2.scale <14 && secondStart ){
		    secondStart = false
		    tween3.start()
		    var audio = document.getElementById("myAudio"); 
		    document.getElementById('myAudio').muted = false
			audio.play();
		    
		    try{
			    if(!confetiStart){
				    confetiStart = true;
		   	var confettiElement = document.getElementById('whole');
			var confettiSettings = { target: confettiElement , clock : 56};
			var confetti = new ConfettiGenerator(confettiSettings);
			confetti.render();
			    }
		    }catch(e){
			   alert(e); 
		    }
	    }
	    	    box.scale.set(current2.scale,current2.scale,current2.scale);
    }
    
    var update3 = function(){
	    if(current3.scale == 0.35){
		    finished = true
	    }
	    ps5.rotation.y = current3.rotation;
	    ps5.scale.set(current3.scale,current3.scale,current3.scale);
    }

    	var easing1	= TWEEN.Easing.Linear.None;
	    var easing2 = TWEEN.Easing.Back.InOut;
	    var easing3 = TWEEN.Easing.Quartic.Out;	    
	    
		var tween0	= new TWEEN.Tween(current0)
		.to({wait :10}, 10000)
		.delay(10)
		.repeat(Infinity)
		.easing(easing1)
		.onUpdate(update0);

	    var tween1	= new TWEEN.Tween(current1)
		.to({time :9000}, 9000)
		.delay(1000)
		.easing(easing1)
		.onUpdate(update1);
	    
	    var tween2 = new TWEEN.Tween(current2)
		.to({scale : 0}, 1400)
		.delay(10)
		.easing(easing2)
		.onUpdate(update2);
	    
	    var tween3 = new TWEEN.Tween(current3)
		.to({rotation: (8*Math.PI),scale :0.42}, 8000)
		.delay(10)
		.easing(easing3)
		.onUpdate(update3);
	    
	    tween1.chain(tween2);
// 	    tween2.chain(tween3);

			ARnft.ARnft.init(800, 600, "archive/DataNFT/cola14", 'config3.json', false, true)
			.then((nft) => {
				nft_loaded = nft;
				
				document.addEventListener('onInitThreejsRendering', (ev) => {
					const renderer = ev.detail.renderer;
					const scene = ev.detail.scene;
					const camera = ev.detail.camera;
					
  					renderer.outputEncoding = THREE.sRGBEncoding;
                                        renderer.textureEncoding = THREE.sRGBEncoding
					renderer.physicallyCorrectLights = true;
				
					const light1  = new THREE.AmbientLight(0xFFFFFF, 0.3);
					    light1.name = 'ambient_light';
					    camera.add( light1 );

					let directionalLight = new THREE.DirectionalLight(0xFFFFFF, 0.8 * Math.PI);
					directionalLight.position.set(72, 0, 5);
					camera.add(directionalLight);
					
					window.addEventListener('touchstart', () => {
					    // document.getElementById('myAudio').muted = false
					    // document.getElementById('myAudio').muted = true
					    // document.getElementById('myAudio').play() 

					  });
					
				
					
					//nft_loaded.addSimpleText( 140 , 0 ,0 , "یه کلیک مونده تا جایزه تو باز کنی" ,"text" ,"rgba(228, 233, 237, 1)","rgba(142, 68, 173, 1)" , 19 );
					 
					// 35  -10  -30  28
					//  72   0  -30  108
					
					nft.addSimpleAnimatedModel('./coin.glb',72,20,-28,2,function(gltf,model){
						
						 nft.setOnObjectClickListener('./coin.glb',function(){
							var mixer = new THREE.AnimationMixer(model);
							 var action = mixer.clipAction(gltf.animations[1]);
						var action1 = mixer.clipAction(gltf.animations[2]);
						action.setLoop(THREE.LoopOnce);
   							 action.clampWhenFinished = true;
							 action.play();

							 action1.setLoop(THREE.LoopRepeat);
   							// action1.clampWhenFinished = true;
							 action1.play();
						
						nft.mixers.push(mixer);
						 });
						
					});
					
					nft.addSimpleAnimatedModel('./coca.glb' , 72 , -10 ,-56, 58 , function(gltf,model){
						
							box = model;
							//box.rotation.x = (Math.PI / 2);
 							box.rotation.y = (-1*Math.PI /4);

							nft.setOnObjectClickListener('./coca.glb',function(){
							try{
							 var mixer = new THREE.AnimationMixer(model);
							 var action = mixer.clipAction(gltf.animations[0]);
							 var action1 = mixer.clipAction(gltf.animations[1]);
								var action2 = mixer.clipAction(gltf.animations[2]);
								var action3 = mixer.clipAction(gltf.animations[3]);
							 action.setLoop(THREE.LoopOnce);
   							 action.clampWhenFinished = true;
							 action.play();

							 action1.setLoop(THREE.LoopOnce);
   							 action1.clampWhenFinished = true;
							 action1.play();
								
								action2.setLoop(THREE.LoopOnce);
   							 action2.clampWhenFinished = true;
							 action2.play();
								
								action3.setLoop(THREE.LoopOnce);
   							 action3.clampWhenFinished = true;
							 action3.play();
								
								

							 nft.mixers.push(mixer);
							}catch(e){
								alert(e);	
							}
						});
						
					});


// try{
// 	let geometry1	= new THREE.CylinderGeometry(56,56, 4, 32,1);
// 	let loader = new THREE.TextureLoader();
// 	let texture = loader.load( 'tiles.jpg');

// 	texture.wrapS = THREE.RepeatWrapping;
// 	texture.wrapT = THREE.RepeatWrapping;
// 	texture.repeat.set(4,2);
// 	let material1	= new THREE.MeshBasicMaterial({
// 		transparent : true,
// 		map: texture,
// 		side: THREE.BackSide
// 	}); 
// 	mesh1 = new THREE.Mesh( geometry1, material1 );
// 	mesh1.position.y = -2;
//         mesh1.position.x = 70;
//         mesh1.rotation.x = ( Math.PI / 2 )
// 	nft.root.add( mesh1 );
	
// 	// the invisibility cloak (ring; has circular hole)
// 	let geometry0 = new THREE.RingGeometry(1,56, 32);
// 	let material0 = new THREE.MeshBasicMaterial({
// 		// map: loader.load( 'images/color-grid.png' ), // for testing placement
// 		colorWrite: false
// 	});
// 	let mesh0 = new THREE.Mesh( geometry0, material0 );
// 	mesh0.rotation.x = -Math.PI/2;
// 	nft.root.add(mesh0);
// }catch(e){ alert(e) }					
					
					
				})
				
			
				document.addEventListener('getMatrixGL_RH', (ev) => {
					try{
						// if(flag){
						// 	flag = false
						// 	tween1.start()
						
						// }
					}catch(e){
						alert(e)
					}
				});
            });

    </script>
</body>

</html>
