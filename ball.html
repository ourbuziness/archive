<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Mosallas</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=0.5, maximum-scale=1">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<link rel="stylesheet" href="nft-style.css">
	<canvas id="whole" style="position: absolute;z-index:999"></canvas>
	<p id="pos" style="position: absolute;z-index:999;background-color: #fff;left:40px">position</p>
	<button id="reset" style="position: absolute;z-index:999;bottom: 100px; right:100px">try sgain</button>
	<progress id="power" value="10" max="100" style="-webkit-transform: rotate(-90deg); position: absolute;z-index:999;top:100px"></progress>

</head>
<body>

	<audio id="kick">
		<source src="kick.mp3.mp3" type="audio/mpeg"></source>
	</audio>

	<audio id="myAudio1">
		<source src="count.mp3" type="audio/mpeg"></source>
	</audio>
	
	
		<script src="three.min.js"></script>
		<script src="ARnft.js"></script>
        	<script type='text/javascript' src='Tween.js'></script>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
		<script type='text/javascript' src='OrbitControls.js'></script>
		<script src="confetti.js"></script>
		<script src="jquery.min.js"></script>
	
    <script>
      
      let nft_loaded;
	    let goal ;
	    let ball ;
	    let path ;
	    let pointsPath;
	    let y4;
        let length = 50;
        let height = 20;
	let sheddatArray = [70,90,95,100,110,120,130,140,150,180];
        let shedat = 1;
	    let prog = 10;
	    let steps = 0.03;
	    let end = false ;
	    let fraction = 0
	    const up = new THREE.Vector3( 0,1, 0 );
  	    const axis = new THREE.Vector3( );
	    let interval;
	    let step = 10 // for interval power
        let v0;
        let gg = 9.8
        let A;
	    let vy;
	    let vz;
        let alpha;
	    let time;
	    let endx
	    let endy
	    let startx
	    let starty
	    let shib
	    let starte
	    let canStarte = true
    
      
	       $("#reset").click(function(){
        reset();
    }); 
	
	    
	 function click(x, y)
{
    var e = $.Event('click');

// set coordinates
e.pageX = x;
e.pageY = y;

// trigger event - must trigger on document
$(document).trigger(e);

}

      function createPath(x,y,z){
	    //  alert("ymz")
	      try{
	//if(x==0)
             A = x
       //  else
	  //   A = Math.tan(x)
		     // alert("A : "+A);
		      if(z>0)
        alpha = z*Math.PI / 180
		      else
			      alpha = 0
		    //   alert("alpha : "+alpha);
		      vy = v0*Math.cos(alpha)
        vz = v0*Math.sin(alpha)
//         var R = v0*v0*Math.sin(2*alpha)/gg

        time = 0;
			//alert("time : "+time);
		      end = false;
        nft_loaded.tickExtend = function(){
		//alert("tick");
          if(!end){
		  try{
			  
            time += steps
            createCubic(time);
		  }catch(e){
			alert(e)  
		  }
		  
          }else{
		//alert("end")  
	  }

        };
	      }catch(e){alert(e)}
        
      }
	    
	    function reset(){
		ball.position.x = 70
		  ball.position.y = 5
		    ball.position.z = 0
		    time = 0
		    startInterval()
		  //  end = false
		    
		    
	    }

      function createCubic(time){
     try{
	    // alert("here");
        
        var y = vy*time + 5
        var z = 0
	if(vz !=0 )
	   z= -0.5*gg**time*time + vz*time
	     else
	z=0
		     
        var x = linearPath(y) + 70
	
// 	$("#pos").text("( "+ x+" , "+y+" , "+z+" )")

        if((z<0 || y>=goal.position.y) && time != 0){
		//alert("end")
          end = true
        }else{
          ball.position.x = x
          ball.position.y= y
          ball.position.z = z
          ball.rotation.y += 0.3
        }
	        }catch(e){
			alert(e);    
		    }
      }

      function linearPath(y){
	      var x = 1
	      if(A !=0)
       		x = y / A
	      else
		x = 0
        return x
      }
	    
	    function startInterval(){
		    interval = setInterval(function() {
	  prog = prog + step
	  if(prog>100){
		  prog = 90
		  step = -10
	  }
	  if(prog <0 ){
		  prog = 10
		  step = 10
	  }
   document.getElementById("power").value = prog;
 }, 140);
		    
	    }

			ARnft.ARnft.init(800, 600, "archive/DataNFT/notebook", 'config3.json', false, true)
			.then((nft) => {
				startInterval()
				nft_loaded = nft;

				document.addEventListener('onInitThreejsRendering', (ev) => {
					const renderer = ev.detail.renderer;
					const scene = ev.detail.scene;
					const camera = ev.detail.camera;
					
  					renderer.outputEncoding = THREE.sRGBEncoding;
                                        renderer.textureEncoding = THREE.sRGBEncoding
					renderer.physicallyCorrectLights = true;
				
					const light1  = new THREE.AmbientLight(0xFFFFFF, 0.3);
					    light1.name = 'ambient_light';
					    camera.add( light1 );

					let directionalLight = new THREE.DirectionalLight(0xFFFFFF, 0.8 * Math.PI);
					directionalLight.position.set(0.5, 0, 0.866);
					camera.add(directionalLight);

          
          nft.addSimpleModel('./ball.glb' , 70 , 5 ,0,20 , function(model){
		  ball = model;
		  
		  nft.setOnObjectClickListener('./ball.glb',function(point){
			  alert("clicked")
			  
			  var audio = document.getElementById("kick");
                              audio.play();
			  
			 clearInterval(interval);
			  shedat = sheddatArray[(prog/10 | 0)]
			  v0 = sheddatArray[(prog/10 | 0)]
//v0 = 140
 			  var v = new THREE.Vector3()
// 			  camera.getWorldDirection(v);
// 			  alert("YMZ " + v.x +" , "+ v.y +" , "+v.z);
// 			  alert("YMZ (" + camera.position.x + " , " + camera.position.y + " , " + camera.position.z + ")" + "\n ("+camera.rotation.x + " , " + camera.rotation.y + " , " + camera.rotation.z + ")"  );
// 		 		alert("YMZ " + nft_loaded.renderer.camera.projectionMatrix);
 			  model.getWorldPosition(v)
// 			 alert("YMZ " + v.x +" , "+ v.y +" , "+v.z);
// 			 const q = new THREE.Quaternion();
// 			  model.getWorldQuaternion(q)
// 			  var t = model.worldToLocal(point)
// 			alert("YMZ " + q.x +" , "+ q.y +" , "+q.z);
			  var p1 =  model.worldToLocal(point);
			  var p2 = model.worldToLocal(v);
// 			 alert("YMZ : xs :  "+ ((*100) | 0) + " , ys : "+ (((p1.y - p2.y)*100) | 0 )    );
			  
     //  var xxs = (p1.x - p2.x)*100 | 0
			 var yys = (p1.y - p2.y)* 100 | 0
			 var zzs = (p1.z - p2.z)*100 | 0
			 zzs = -1*zzs
			 if(zzs < -80){
				zzs = 0	 
			 }else{
				zzs = ((zzs + 80)* 72)/130
			 }
			  try{
			  
// 				var xxs =  ((((p1.x) *100) | 0)+ 30)
// 				alert(xxs + "   " + (p1.x * 100) );
// 				var xxsArrayP = [0,95,100,105,110,115,120]
// 				var xxsArrayN = [0,85,80,75,70,65,60]
// 				if(xxs > 120 ) xxs = 120
// 				  if(xxs < -70 ) xxs = -60
// 				if(xxs <=5 && xxs >= -5) xxs = 0
// 				else if(xxs > 0 ){
// 					xxs =xxsArrayP[Math.ceil(xxs/20)]
// 				}else{
// 					xxs = xxsArrayN[Math.ceil(xxs/10)]
// 				}
				  
/*				  var xxs = ((((p1.x) *100) | 0)+ 30)
// 				  alert(xxs)
				  if(xxs <= 5 && xxs >= -5) xxs= 0
				  else if(xxs > 0) {
// 					  alert("mosbat");
					  if(xxs <= 20 ) xxs = -30
				  else if(xxs <= 30) xxs = -25
				  else if(xxs<=40) xxs = -20
				  else if(xxs<=50)xxs = -15
					  else if(xxs <= 60 ) xxs = -10
					 else if(xxs <= 70 ) xxs = -5
					  else if(xxs <= 80) xxs = -2
				  else xxs = -1
			  	}else{
// 					alert("manfi");
				  if(xxs>= -10) xxs = 30
					else if(xxs >= -20) xxs= 25
					else if(xxs >= -25) xxs = 20
					else if(xxs>= -30 ) xxs = 15
					else if(xxs>= -35 ) xxs = 10
					else if(xxs>= -40 ) xxs = 5
					else if(xxs>= -50 ) xxs = 2
					else xxs = 1
				}*/
				  
// 				  alert("xxs : " +xxs);
				  
			//  createGraph(xxs + 20,yys + 65,zzs + 40);
				  
var xxs = -1* shib
 createPath(xxs,yys + 28 ,zzs);
   			 $("#pos").text("alpha : "+ zzs + "\nx : " + xxs)
			  }catch(e){
			alert(e);	  
			  }
// alert("y: "+ ( yys+ 28) +" x : " + (xxs+ 20) + "A : " + ((xxs + 20)/85) + "  alpha : "+ (-1*zzs + 20) );
			 
		  });

						
// 						nft.tickExtend = function() {

// 						};
						
									});
          
          
                    nft.addSimpleModel('./goal.glb' , 70 , 250 ,0,2 ,function(model){

					goal = model;	
			    goal.rotation.y = (Math.PI /2)
			    
			        $(document).on('touchstart', 'body', function (e) {
					 $("#pos").text("ts : ( "+  e.originalEvent.touches[0].pageX + " , " +  e.originalEvent.touches[0].pageY + ")" )
					if(canStarte){
               canStarte = false
					starte = e
    startx= e.originalEvent.touches[0].pageX
   starty= e.originalEvent.touches[0].pageY
					}
});
$(document).on('touchend', 'body', function (e) {
	try{
		alert(starte)
   endx= e.originalEvent.changedTouches[0].pageX;
   endy= e.originalEvent.changedTouches[0].pageY;
	
	 shib = (endy - starty) / (endx - startx)
	// alert("shib  : " + shib )
	//nft_loaded.simulateClick(starte)
		click(startx, starty);
	canStarte = true
}catch(e){
	alert(e)
}
});
			    
									});
					
					

				});
				
				
			
				document.addEventListener('getMatrixGL_RH', (ev) => {
					try{
// 						var m = ev.detail.matrixGL_RH
						
					}catch(e){
						alert(e)
					}
				});
            });

    </script>
</body>

</html>
