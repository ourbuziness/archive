<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Mosallas</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=0.5, maximum-scale=1">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<link rel="stylesheet" href="nft-style.css">
	<canvas id="whole" style="position: absolute;z-index:999"></canvas>
	<p id="pos" style="position: absolute;z-index:999">position</p>
	<progress id="power" value="10" max="100" style="-webkit-transform: rotate(-90deg); position: absolute;z-index:999;top:100px"></progress>

</head>
<body>

	<audio id="myAudio">
		<source src="win.mp3" type="audio/mpeg"></source>
	</audio>

	<audio id="myAudio1">
		<source src="count.mp3" type="audio/mpeg"></source>
	</audio>
	
	
		<script src="three.min.js"></script>
		<script src="ARnft.js"></script>
        	<script type='text/javascript' src='Tween.js'></script>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
		<script type='text/javascript' src='OrbitControls.js'></script>
		<script src="confetti.js"></script>
		<script src="jquery.min.js"></script>
	
    <script>
      
      let nft_loaded;
	    let goal ;
	    let ball ;
	    let path ;
	    let pointsPath;
	    let y4;
        let length = 50;
        let height = 20;
	let sheddatArray = [3,6,9,12,15,20,25,30,35,40];
        let shedat = 1;
	    let prog = 10;
	    let step = 10;
	    let end = false ;
	    let fraction = 0
	    const up = new THREE.Vector3( 0,1, 0 );
  	    const axis = new THREE.Vector3( );
	    let interval;
        let v0;
        let gg = 9.8
        let A;
	    let vy;
	    let vz;
        let alpha;
    
      
	    function randomIntFromInterval(a1,a2) { // min and max included 
		    var max = a1 + 30
		    var min = a2
		    if(a1 > a2 ){
			max = a1
			min = a2
		    }else if(a1 < a2){
			max = a2
			    min = a1
		    }
  		return Math.floor(Math.random() * (max - min + 1) + min)
		}
	    
	    
	    function moveBall(){
		    try{		    
    const newPosition = pointsPath.getPoint(fraction);
    const tangent = pointsPath.getTangent(fraction);
    ball.position.copy(newPosition);
    axis.crossVectors( up, tangent ).normalize();
    
    const radians = Math.acos( up.dot( tangent ) );
    
    ball.quaternion.setFromAxisAngle( axis, radians );
    
    fraction +=(0.02*shedat);
    if (fraction > 1) {
      fraction = 0;
    }    
		    }catch(e){
			alert(e);    
		    }
		    
	    }
      
      function createGraph(x,y,z){
	      try{
	      try{
		  var selectedObject = nft_loaded.root.getObjectByName("ymz_path");
    	  nft_loaded.root.remove( selectedObject );
		      
	      }catch(e){
		      
	      }
	      var v1 = new THREE.Vector3( 70 , 5 ,0 );
	      
	      let x4;
	      let z4;
          let state = 1

          if(x< 0 && y > 0){
            state = 1
            var direction = 1
            if(x < -10) direction =2

            var dd = (length/3)*direction*shedat
            x4 = goal.position.x + dd
            y4 = -1 *goal.position.y*shedat
          }
          else if(y > 0 && x > 0){
            state = 2
            var direction = 1
            if(x > 10) direction =2
            var dd = (length/3)*direction*shedat

            x4 = goal.position.x - dd
            y4 = -1 *goal.position.y*shedat

          }else if(y <= 0 && x<=0){
            state = 3
            var direction = 1
            if(x <-10) direction =2
            if(x>-5) direction = 0

            var dd = (length/3)*direction*shedat
            x4 = goal.position.x + dd
            y4 = goal.position.y*shedat
          }else{
            state = 4
            var direction = 1
            if(x <-20) direction =2
            if(x>-5) direction = 0

            var dd = (length/3)*direction*shedat
            x4 = goal.position.x - dd
            y4 = goal.position.y*shedat
          }
	      
	      
	      if(z <= 0 ){
			z4 =  goal.position.z*shedat*2 - height
	      }else{
		      z4 = 0
	      }
	      var v4 = new THREE.Vector3(x4,y4,z4);

          let v2;
          let v3;

          if(state ==1 || state == 3){
              v2 = new THREE.Vector3(x4*1.4,y4*0.3,z4*1.5); 
              v3 = new THREE.Vector3(x4*1.7,y4*0.7,z4*2);
          }else if(state ==2 || state == 4){
            v2 = new THREE.Vector3(x4*0.4,y4*0.3,z4*1.5); 
              v3 = new THREE.Vector3(x4*0.7,y4*0.7,z4*2);
          }
	         
          addVectors(v1,v2,v3,v4)
	      }catch(e){
		alert(e)      
	      }
      }

      function addVectors(v1,v2,v3,v4){
        pointsPath = new THREE.CurvePath();

const bezierLine = new THREE.CubicBezierCurve3(
  v1,
  v2,
  v3,
  v4
);

  pointsPath.add(bezierLine);
            
  const material = new THREE.LineBasicMaterial({
  color: 0x9132a8
});
  const points = pointsPath.curves.reduce((p, d)=> [...p, ...d.getPoints(20)], []);

  const geometry = new THREE.BufferGeometry().setFromPoints( points );


  path = new THREE.Line( geometry, material );

        path.name = "ymz_path"

// 		      alert(x4 + " , " + y4 + " , " + z4  + "\n ** "+ x3 + " , " + y3 + " , " + z3 );
                                 try{
              //                     nft_loaded.add(path);
             //    nft_loaded.tickExtend = function() {
              //        moveBall();
                //       };
                 
                 }catch(e){  
                       alert(e) 
                                 }
      }


      function createPath(x,y,z){
	      alert("ymz")
	      try{
        A = (y/x)
		      alert("A : "+A);
        alpha = z*Math.PI / 180
		       alert("alpha : "+alpha);
		      vy = v0*Math.cos(alpha)
        vz = v0*Math.sin(alpha)
//         var R = v0*v0*Math.sin(2*alpha)/gg

        var time = 0;
			alert("time : "+time);
        nft_loaded.tickExtend = function(){
		//alert("tick");
          if(!end){
		  try{
            time += 0.01
            createCubic(time);
		  }catch(e){
			alert(e)  
		  }
		  
          }else{
		//alert("end")  
	  }

        };
	      }catch(e){alert(e)}
        
      }

      function createCubic(time){
     try{
	    // alert("here");
        
        var y = vy*time + 5
        var z = -0.5*gg**time*time + vz*time
        var x = linearPath(y) + 70
	
	$("#pos").text("( "+ x+" , "+y+" , "+z+" )")

        if(z<0 && time != 0){
		//alert("end")
          end = true
        }else{
          ball.position.x = x
          ball.position.y= y
          ball.position.z = z
        }
	        }catch(e){
			alert(e);    
		    }
      }

      function linearPath(y){
       var x = y / A
        return x
      }

			ARnft.ARnft.init(800, 600, "archive/DataNFT/notebook", 'config3.json', false, true)
			.then((nft) => {
				nft_loaded = nft;

				document.addEventListener('onInitThreejsRendering', (ev) => {
					const renderer = ev.detail.renderer;
					const scene = ev.detail.scene;
					const camera = ev.detail.camera;
					
  					renderer.outputEncoding = THREE.sRGBEncoding;
                                        renderer.textureEncoding = THREE.sRGBEncoding
					renderer.physicallyCorrectLights = true;
				
					const light1  = new THREE.AmbientLight(0xFFFFFF, 0.3);
					    light1.name = 'ambient_light';
					    camera.add( light1 );

					let directionalLight = new THREE.DirectionalLight(0xFFFFFF, 0.8 * Math.PI);
					directionalLight.position.set(0.5, 0, 0.866);
					camera.add(directionalLight);

          
          nft.addSimpleModel('./ball.glb' , 70 , 5 ,0,20 , function(model){
		  ball = model;
		  
		  nft.setOnObjectClickListener('./ball.glb',function(point){
			 clearInterval(interval);
			  shedat = sheddatArray[(prog/10 | 0)]
			  v0 = sheddatArray[(prog/10 | 0)]
v0 = 140
 			  var v = new THREE.Vector3()
// 			  camera.getWorldDirection(v);
// 			  alert("YMZ " + v.x +" , "+ v.y +" , "+v.z);
// 			  alert("YMZ (" + camera.position.x + " , " + camera.position.y + " , " + camera.position.z + ")" + "\n ("+camera.rotation.x + " , " + camera.rotation.y + " , " + camera.rotation.z + ")"  );
// 		 		alert("YMZ " + nft_loaded.renderer.camera.projectionMatrix);
 			  model.getWorldPosition(v)
// 			 alert("YMZ " + v.x +" , "+ v.y +" , "+v.z);
// 			 const q = new THREE.Quaternion();
// 			  model.getWorldQuaternion(q)
// 			  var t = model.worldToLocal(point)
// 			alert("YMZ " + q.x +" , "+ q.y +" , "+q.z);
			  var p1 =  model.worldToLocal(point);
			  var p2 = model.worldToLocal(v);
// 			 alert("YMZ : xs :  "+ ((*100) | 0) + " , ys : "+ (((p1.y - p2.y)*100) | 0 )    );
			  
      var xxs = (p1.x - p2.x)*100 | 0
			 var yys = (p1.y - p2.y)* 100 | 0
			 var zzs = (p1.z - p2.z)*100 | 0
			 
			//  createGraph(xxs + 20,yys + 65,zzs + 40);

    createPath(xxs + 14,yys + 28 ,(-1*zzs + 40));
// alert("y: "+ ( yys+ 56) +" x : " + (xxs+ 14) + "A : " + ((yys + 65)/(xxs + 20)) + "  alpha : "+ (-1*zzs + 70) );
			 
		  });

						
// 						nft.tickExtend = function() {

// 						};
						
									});
          
          
                    nft.addSimpleModel('./goal.glb' , 70 , 250 ,0,1 , function(model){

					goal = model;	
			    goal.rotation.y = (Math.PI /2)
									});
					
					
  interval = setInterval(function() {
	  prog = prog + step
	  if(prog>100){
		  prog = 90
		  step = -10
	  }
	  if(prog <0 ){
		  prog = 10
		  step = 10
	  }
   document.getElementById("power").value = prog;
 }, 140);

				});
				
				
			
				document.addEventListener('getMatrixGL_RH', (ev) => {
					try{
// 						var m = ev.detail.matrixGL_RH
						
					}catch(e){
						alert(e)
					}
				});
            });

    </script>
</body>

</html>
